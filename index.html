<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ExamTopper</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #002147; --bg: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; background: var(--bg); font-family: 'Poppins', sans-serif; overflow: hidden; }
        .view { display: none; height: 100vh; width: 100vw; padding: 30px; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        .auth-card { width: 100%; max-width: 350px; text-align: center; }
        .logo { width: 100px; height: 100px; margin-bottom: 10px; border-radius: 50%; border: 2px solid var(--navy); }
        .input-group { width: 100%; margin-bottom: 15px; position: relative; }
        .input-group input { width: 100%; padding: 16px; border: 2px solid #f1f5f9; border-radius: 12px; outline: none; background: #fafafa; width: 100%; font-size: 15px; }
        .eye { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer; }
        .btn { width: 100%; padding: 16px; background: var(--navy); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee; width: 100%; position: fixed; top: 0; background: white; }
        #v-dash { justify-content: flex-start; padding-top: 100px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="v-login" class="view active">
        <div class="auth-card">
            <img src="https://lh3.googleusercontent.com/d/1obO5_MsRtrX8xqGW4JfymBqbkOuIOmJ2" class="logo">
            <h2 style="color:var(--navy); margin:0;">ExamTopper</h2>
            <div class="input-group"><input type="email" id="l-email" placeholder="Email Address"></div>
            <div class="input-group">
                <input type="password" id="l-pass" placeholder="Password">
                <i class="fas fa-eye eye" onclick="togglePass('l-pass', this)"></i>
            </div>
            <button class="btn" onclick="doLogin()">Login</button>
            <p style="margin-top:20px; font-size:13px;">New user? <b onclick="show('v-signup')" style="color:var(--navy)">Sign Up</b></p>
            <div id="msg-l" style="margin-top:10px; font-size:12px; font-weight:600;"></div>
        </div>
    </div>

    <div id="v-signup" class="view">
        <div class="auth-card">
            <h2 style="color:var(--navy)">Register</h2>
            <div class="input-group"><input type="text" id="s-name" placeholder="Full Name"></div>
            <div class="input-group"><input type="email" id="s-email" placeholder="Email Address"></div>
            <div class="input-group"><input type="tel" id="s-phone" placeholder="Phone Number"></div>
            <div class="input-group">
                <input type="password" id="s-pass" placeholder="Password">
                <i class="fas fa-eye eye" onclick="togglePass('s-pass', this)"></i>
            </div>
            <button class="btn" onclick="doSignup()">Create Account</button>
            <p onclick="show('v-login')" style="margin-top:15px; font-size:13px;">Back to Login</p>
            <div id="msg-s" style="margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div id="v-dash" class="view">
        <div class="header">
            <h3 id="u-name" style="margin:0; color:var(--navy)">Hi!</h3>
            <i class="fas fa-power-off" style="color:red; font-size:20px;" onclick="doLogout()"></i>
        </div>
        <div id="class-list" style="width:100%"></div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbyAaBt7GfIWplI7wh-xnSBjqenajX6WbowprIbIH1xdncfIJhcX5lMubUwJIYRrzGE1Hg/exec";
        let statusInterval;

        function show(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function togglePass(id, el) {
            const x = document.getElementById(id);
            x.type = x.type === "password" ? "text" : "password";
            el.classList.toggle('fa-eye-slash');
        }

        // THE BRUTAL CHECKER
        async function checkBrutalStatus() {
            const session = JSON.parse(localStorage.getItem('et_user'));
            if(!session) return;

            try {
                const res = await fetch(`${API}?action=check_status&email=${session.userEmail}`);
                const d = await res.json();
                if(d.status !== "TRUE") {
                    clearInterval(statusInterval);
                    alert("Session Expired or Logged out by Admin.");
                    forceLogout();
                }
            } catch(e) {}
        }

        async function doLogin() {
            const e = document.getElementById('l-email').value, p = document.getElementById('l-pass').value, m = document.getElementById('msg-l');
            if(!e || !p) return;
            m.style.color = "var(--navy)"; m.innerText = "Verifying...";

            try {
                const res = await fetch(`${API}?action=login&email=${e}&pass=${p}`);
                const d = await res.json();
                if(d.status === 'success') {
                    localStorage.setItem('et_user', JSON.stringify(d));
                    startDashboard(d);
                } else { m.style.color="red"; m.innerText = d.message; }
            } catch { m.innerText = "Connection Error"; }
        }

        function startDashboard(data) {
            document.getElementById('u-name').innerText = "Hi " + data.userName;
            show('v-dash');
            // Start checking every 10 seconds if Admin has flipped the switch
            statusInterval = setInterval(checkBrutalStatus, 10000); 
        }

        async function doLogout() {
            const session = JSON.parse(localStorage.getItem('et_user'));
            if(session) await fetch(`${API}?action=logout_action&email=${session.userEmail}`);
            forceLogout();
        }

        function forceLogout() {
            localStorage.removeItem('et_user');
            clearInterval(statusInterval);
            location.reload();
        }

        async function doSignup() {
            const n = document.getElementById('s-name').value, e = document.getElementById('s-email').value, ph = document.getElementById('s-phone').value, p = document.getElementById('s-pass').value, m = document.getElementById('msg-s');
            if(!n || !e || !ph || !p) { m.innerText = "All fields mandatory"; return; }
            m.innerText = "Processing...";
            const res = await fetch(`${API}?action=register&name=${n}&email=${e}&pass=${p}&phone=${ph}`);
            const d = await res.json();
            m.style.color = "green"; m.innerText = d.message;
        }

        window.onload = () => {
            const session = localStorage.getItem('et_user');
            if(session) startDashboard(JSON.parse(session));
        }
    </script>
</body>
</html>
