<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Student App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
      :root { --primary: #2563eb; --locked: #94a3b8; --bg: #ffffff; --text: #1e293b; --card-bg: #ffffff; }
      * { box-sizing: border-box; }
      body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }
      
      .view-section { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg); overflow-y: auto; padding: 20px; display: none; padding-bottom: 50px; }
      .active-view { display: block; animation: fadeUp 0.3s ease; }
      @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .auth-container { display: flex; flex-direction: column; justify-content: center; min-height: 100%; max-width: 400px; margin: 0 auto; }
      .app-logo { width: 150px; height: auto; display: block; margin: 0 auto 20px auto; border-radius: 12px; object-fit: contain; }
      .auth-title { text-align: center; font-size: 22px; font-weight: 700; margin-bottom: 30px; color: #334155; letter-spacing: -0.5px; }
      
      .input-wrapper { position: relative; margin-bottom: 16px; }
      .input-wrapper input { width: 100%; padding: 16px; padding-right: 45px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; outline: none; background: white; }
      .toggle-pass { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer; padding: 5px; font-size: 18px; }
      
      button.primary-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer; }
      button.primary-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
      .link-text { text-align: center; margin-top: 15px; color: var(--primary); font-size: 14px; font-weight: 600; cursor: pointer; }

      .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 10px; }
      .welcome-text h2 { margin: 0; font-size: 20px; font-weight: 700; }
      .welcome-text p { margin: 4px 0 0; color: #64748b; font-size: 14px; }
      
      .back-btn { font-size: 18px; color: var(--text); cursor: pointer; padding: 5px; display: flex; align-items: center; gap: 8px; }
      .logout-btn { color: #ef4444; font-size: 18px; padding: 10px; background: #fee2e2; border-radius: 8px; cursor: pointer; }
      
      .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      
      .course-card { background: var(--card-bg); border-radius: 16px; padding: 24px 16px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); cursor: pointer; border: 1px solid #f1f5f9; transition: transform 0.1s; text-decoration: none; color: inherit; display: block; }
      .course-card:active { transform: scale(0.96); }
      .course-card.locked { background: #f8fafc; border: 1px dashed #cbd5e1; opacity: 0.7; }
      .course-card.locked i { color: var(--locked); }
      .course-card.unlocked i { color: var(--primary); }
      .course-card i { font-size: 28px; margin-bottom: 12px; display: block; }
      .course-card h3 { margin: 0; font-size: 15px; font-weight: 600; }
      
      .subject-math i { color: #ea580c; }
      .subject-science i { color: #16a34a; }
      .subject-eng i { color: #9333ea; }
      .subject-sst i { color: #db2777; }

      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
      .modal-content { background: white; width: 85%; max-width: 320px; padding: 30px 20px; border-radius: 20px; text-align: center; }
      .modal-icon { font-size: 48px; color: #ef4444; margin-bottom: 16px; }
    </style>
  </head>
  <body>

    <div id="view-login" class="view-section active-view">
      <div class="auth-container">
        <h2 class="auth-title">Learn. Grow. Succeed.</h2>
        <div class="input-wrapper"><input type="email" id="login-email" placeholder="Email Address"></div>
        <div class="input-wrapper">
          <input type="password" id="login-pass" placeholder="Password">
          <i class="fas fa-eye toggle-pass" onclick="togglePassword('login-pass', this)"></i>
        </div>
        <button class="primary-btn" id="btn-signin" onclick="handleLogin()">Sign In</button>
        <div class="link-text" onclick="switchView('view-signup')">Create New Account</div>
        <div class="link-text" onclick="switchView('view-forgot')" style="font-weight:400; font-size:13px; margin-top:10px;">Forgot Password?</div>
        <div id="login-msg" style="text-align:center; margin-top:15px; color:#ef4444; font-size:14px;"></div>
      </div>
    </div>

    <div id="view-signup" class="view-section">
      <div class="auth-container">
        <h2 class="auth-title">Create Account</h2>
        <div class="input-wrapper"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <div class="input-wrapper"><input type="email" id="reg-email" placeholder="Email Address"></div>
        <div class="input-wrapper"><input type="tel" id="reg-phone" placeholder="Phone Number"></div>
        <div class="input-wrapper">
          <input type="password" id="reg-pass" placeholder="Create Password">
          <i class="fas fa-eye toggle-pass" onclick="togglePassword('reg-pass', this)"></i>
        </div>
        <button class="primary-btn" id="btn-signup" onclick="handleSignup()">Sign Up</button>
        <div class="link-text" onclick="switchView('view-login')">Back to Login</div>
        <div id="signup-msg" style="text-align:center; margin-top:15px; font-size:14px;"></div>
      </div>
    </div>

    <div id="view-forgot" class="view-section">
      <div class="auth-container">
        <h2 class="auth-title">Reset Password</h2>
        <div class="input-wrapper"><input type="email" id="forgot-email" placeholder="Your Email"></div>
        <button class="primary-btn" onclick="submitForgot()">Submit Request</button>
        <div class="link-text" onclick="switchView('view-login')">Back to Login</div>
        <div id="forgot-msg" style="text-align:center; margin-top:15px;"></div>
      </div>
    </div>

    <div id="view-dashboard" class="view-section">
      <div class="dash-header">
        <div class="welcome-text"><h2 id="user-greeting-name">Hi Student</h2><p>Select your class</p></div>
        <div class="logout-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></div>
      </div>
      <div id="classes-grid" class="grid-container"></div>
    </div>

    <div id="view-subjects" class="view-section">
      <div class="dash-header">
        <div class="back-btn" onclick="switchView('view-dashboard')">
           <i class="fas fa-arrow-left"></i> <span id="selected-class-title">Class Name</span>
        </div>
      </div>
      <div class="welcome-text" style="margin-bottom: 20px;">
        <p>Select a subject to start learning</p>
      </div>
      <div id="subjects-grid" class="grid-container"></div>
    </div>

    <div id="paywall-modal" class="modal-overlay" onclick="closePaywall()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <i class="fas fa-lock modal-icon"></i><h3>Access Locked</h3>
        <p>You do not have a subscription for this class.</p>
        <button class="primary-btn" style="background:#ef4444;" onclick="closePaywall()">Close</button>
      </div>
    </div>

    <script>
      // 1. UPDATE THIS URL with your newly deployed script URL
      const API_URL = "https://script.google.com/macros/s/AKfycbygNrVRRNrVPP6rLtBYuNiqPzz_6NKv2bNz0kQEjMMcr8iu9PU_mXzQ7wP-sV76OVuW/exec";

      // 2. HELPER TO GENERATE OR GET DEVICE ID
      function getDeviceId() {
        let id = localStorage.getItem('student_device_id');
        if (!id) {
          // Create a random ID and store it
          id = 'device_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
          localStorage.setItem('student_device_id', id);
        }
        return id;
      }

      // === CBSE SUBJECT DATA MAPPING ===
      const subjectData = {
        class8: [
          { name: "Mathematics", icon: "fa-calculator", file: "class8math.html", colorClass: "subject-math" },
          { name: "Science", icon: "fa-flask", file: "class8science.html", colorClass: "subject-science" },
          { name: "Social Science", icon: "fa-globe", file: "class8sst.html", colorClass: "subject-sst" },
          { name: "English", icon: "fa-book", file: "class8english.html", colorClass: "subject-eng" },
          { name: "Hindi", icon: "fa-language", file: "class8hindi.html", colorClass: "subject-eng" }
        ],
        // ... (Keep your other class data as is) ...
        class9: [ { name: "Mathematics", icon: "fa-calculator", file: "class9math.html", colorClass: "subject-math" } ],
        class10: [ { name: "Mathematics", icon: "fa-calculator", file: "class10math.html", colorClass: "subject-math" } ],
        class11: [ { name: "Mathematics", icon: "fa-square-root-alt", file: "class11math.html", colorClass: "subject-math" } ],
        class12: [ { name: "Mathematics", icon: "fa-square-root-alt", file: "class12math.html", colorClass: "subject-math" } ]
      };

      // === SESSION ON LOAD ===
      window.onload = function() {
          const saved = localStorage.getItem('student_session');
          if (saved) {
              const data = JSON.parse(saved);
              document.getElementById('user-greeting-name').innerText = "Hi " + data.userName;
              renderClasses(data.permissions);
              showScreen('view-dashboard');
          }
      };

      // === NAVIGATION ===
      window.onpopstate = function(e) {
        if (e.state && e.state.view) showScreen(e.state.view);
        else showScreen('view-login');
      };

      function switchView(viewId) {
        window.history.pushState({view: viewId}, null, '');
        showScreen(viewId);
      }

      function showScreen(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
      }

      function togglePassword(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; icon.classList.replace('fa-eye', 'fa-eye-slash'); } 
        else { input.type = "password"; icon.classList.replace('fa-eye-slash', 'fa-eye'); }
      }

      // === AUTH ACTIONS ===
      async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const msg = document.getElementById('login-msg');
        
        // ** CRITICAL: GET THE DEVICE ID **
        const deviceId = getDeviceId(); 

        if(!email || !pass) return;

        msg.innerText = "Verifying...";
        try {
          // ** UPDATED: Send deviceId in the URL parameters **
          const res = await fetch(`${API_URL}?action=login&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}&deviceId=${encodeURIComponent(deviceId)}`);
          const data = await res.json();
          if(data.status === 'success') {
            localStorage.setItem('student_session', JSON.stringify(data));
            document.getElementById('user-greeting-name').innerText = "Hi " + data.userName;
            renderClasses(data.permissions);
            switchView('view-dashboard');
          } else { msg.innerText = data.message; }
        } catch(e) { msg.innerText = "Connection Error"; }
      }

      async function handleSignup() {
          const name = document.getElementById('reg-name').value;
          const email = document.getElementById('reg-email').value;
          const phone = document.getElementById('reg-phone').value;
          const pass = document.getElementById('reg-pass').value;
          const msg = document.getElementById('signup-msg');
          try {
            const res = await fetch(`${API_URL}?action=register&name=${name}&email=${email}&pass=${pass}&phone=${phone}`);
            const data = await res.json();
            msg.innerText = data.message;
            if(data.status === 'success') setTimeout(() => switchView('view-login'), 2000);
          } catch(e) { msg.innerText = "Error"; }
      }

      function handleLogout() {
          localStorage.removeItem('student_session');
          location.reload();
      }

      async function submitForgot() {
          const email = document.getElementById('forgot-email').value;
          const res = await fetch(`${API_URL}?action=forgot&email=${email}`);
          const data = await res.json();
          document.getElementById('forgot-msg').innerText = data.message;
      }

      // === RENDER CLASSES (DASHBOARD) ===
      function renderClasses(permissions) {
        const grid = document.getElementById('classes-grid');
        grid.innerHTML = "";
        const classes = [
            { key: 'class8', label: 'Class 8' },
            { key: 'class9', label: 'Class 9' },
            { key: 'class10', label: 'Class 10' },
            { key: 'class11', label: 'Class 11' },
            { key: 'class12', label: 'Class 12' }
        ];

        classes.forEach(c => {
          const hasAccess = permissions[c.key];
          const card = document.createElement('div');
          card.className = `course-card ${hasAccess ? 'unlocked' : 'locked'}`;
          card.innerHTML = `<i class="fas ${hasAccess ? 'fa-book-open' : 'fa-lock'}"></i><h3>${c.label}</h3>`;
          
          if (hasAccess) {
              card.onclick = () => loadSubjects(c.key, c.label);
          } else {
              card.onclick = () => showPaywall();
          }
          grid.appendChild(card);
        });
      }

      // === RENDER SUBJECTS (SUB-VIEW) ===
      function loadSubjects(classKey, classTitle) {
        const grid = document.getElementById('subjects-grid');
        const titleEl = document.getElementById('selected-class-title');
        grid.innerHTML = ""; 
        titleEl.innerText = classTitle;
        const subjects = subjectData[classKey] || [];

        if(subjects.length > 0) {
          subjects.forEach(sub => {
            const card = document.createElement('a');
            card.className = `course-card ${sub.colorClass}`;
            card.href = sub.file; 
            card.innerHTML = `<i class="fas ${sub.icon}"></i><h3>${sub.name}</h3>`;
            grid.appendChild(card);
          });
        } else {
          grid.innerHTML = "<p>No subjects found for this class.</p>";
        }
        switchView('view-subjects');
      }

      function showPaywall() { document.getElementById('paywall-modal').style.display = "flex"; }
      function closePaywall() { document.getElementById('paywall-modal').style.display = "none"; }
    </script>
  </body>
</html>
