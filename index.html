<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ExamTopper</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      :root { 
        --bg: #f0f2f5; 
        --text: #1e293b; 
        --card-bg: #ffffff; 
      }
      * { box-sizing: border-box; }
      body { 
        font-family: 'Poppins', sans-serif; 
        background: var(--bg); 
        color: var(--text); 
        margin: 0; 
        height: 100vh; 
        overflow: hidden; 
        -webkit-tap-highlight-color: transparent;
      }
      
      /* --- VIEW MANAGEMENT --- */
      .view-section { 
        height: 100%; 
        width: 100%; 
        position: absolute; 
        top: 0; 
        left: 0; 
        background: var(--bg); 
        overflow-y: auto; 
        padding: 20px; 
        display: none; 
        padding-bottom: 80px; 
      }
      .active-view { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      @keyframes popIn { 
        from { opacity: 0; transform: scale(0.98) translateY(10px); } 
        to { opacity: 1; transform: scale(1) translateY(0); } 
      }

      /* --- AUTH STYLES --- */
      .auth-container { display: flex; flex-direction: column; justify-content: center; min-height: 100%; max-width: 400px; margin: 0 auto; }
      
      .app-logo { width: 110px; height: 110px; display: block; margin: 0 auto 15px auto; border-radius: 50%; object-fit: cover; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: 4px solid white; }
      
      .app-name { text-align: center; font-size: 28px; font-weight: 900; margin: 0; color: #1e293b; letter-spacing: -1px; background: -webkit-linear-gradient(45deg, #2563eb, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .auth-tagline { text-align: center; font-size: 13px; font-weight: 600; margin: 5px 0 25px 0; color: #64748b; text-transform: uppercase; letter-spacing: 1.5px; }

      .input-wrapper { position: relative; margin-bottom: 14px; }
      .input-wrapper input { width: 100%; padding: 16px; padding-right: 45px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 15px; outline: none; background: white; transition: all 0.2s; font-family: inherit; font-weight: 500; }
      .input-wrapper input:focus { border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
      .toggle-pass { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer; padding: 5px; font-size: 18px; }
      
      button.primary-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 8px 15px -5px rgba(37, 99, 235, 0.4); transition: transform 0.1s; letter-spacing: 0.5px; }
      button.primary-btn:active { transform: scale(0.97); }
      button.primary-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
      .link-text { text-align: center; margin-top: 20px; color: #2563eb; font-size: 13px; font-weight: 700; cursor: pointer; }

      /* --- HEADER --- */
      .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 5px; }
      .welcome-text h2 { margin: 0; font-size: 20px; font-weight: 800; color: #0f172a; }
      .welcome-text p { margin: 2px 0 0; color: #64748b; font-size: 13px; font-weight: 500; }
      
      .back-btn { font-size: 14px; color: #334155; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 700; background: white; border-radius: 10px; padding: 8px 14px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; transition: transform 0.1s; }
      .back-btn:active { transform: scale(0.95); }
      
      .logout-btn { color: #dc2626; font-size: 16px; padding: 10px 14px; background: #fee2e2; border-radius: 10px; cursor: pointer; transition: background 0.2s; border: none; }
      .logout-btn:active { background: #fca5a5; transform: scale(0.95); }

      /* --- CLASS LIST (BIG & VERTICAL) --- */
      .classes-container { display: flex; flex-direction: column; gap: 15px; }

      .class-card {
        display: flex;
        align-items: center;
        padding: 20px 20px;
        border-radius: 20px;
        color: white;
        text-decoration: none;
        box-shadow: 0 10px 20px -5px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
      }
      .class-card:active { transform: scale(0.97); }
      
      /* Class Gradients */
      .bg-c8 { background: linear-gradient(120deg, #ff5858 0%, #f09819 100%); }
      .bg-c9 { background: linear-gradient(120deg, #ff9966 0%, #ff5e62 100%); }
      .bg-c10 { background: linear-gradient(120deg, #56ab2f 0%, #a8e063 100%); }
      .bg-c11 { background: linear-gradient(120deg, #00c6ff 0%, #0072ff 100%); }
      .bg-c12 { background: linear-gradient(120deg, #8E2DE2 0%, #4A00E0 100%); }
      
      .class-card.locked { background: #e2e8f0; color: #94a3b8; box-shadow: none; pointer-events: none; border: 2px dashed #cbd5e1; }
      .class-card.locked .class-icon { opacity: 0.5; background: rgba(0,0,0,0.05); }

      .class-icon {
        width: 55px;
        height: 55px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-right: 15px;
        backdrop-filter: blur(8px);
        box-shadow: inset 0 0 15px rgba(255,255,255,0.15);
      }

      .class-info h3 { margin: 0; font-size: 18px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .class-info span { font-size: 12px; opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
      .arrow-icon { font-size: 20px; opacity: 0.8; margin-left: auto; }

      /* --- SUBJECTS GRID (COMPACT & COLORFUL) --- */
      .subjects-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      
      .subject-card {
        min-height: 110px; /* Reduced Height */
        border-radius: 18px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: white;
        text-decoration: none;
        box-shadow: 0 8px 15px -3px rgba(0,0,0,0.2);
        transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.15);
      }
      
      .subject-card:active { transform: scale(0.95); }

      /* Subject Gradients */
      .grad-math { background: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%); }
      .grad-sci { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); }
      .grad-soc { background: linear-gradient(135deg, #F2994A 0%, #F2C94C 100%); }
      .grad-eng { background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%); }
      .grad-hin { background: linear-gradient(135deg, #1A2980 0%, #26D0CE 100%); }
      
      /* Icons size reduced */
      .subject-card i { 
        font-size: 32px; 
        margin-bottom: 8px; 
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
        transition: transform 0.2s;
      }
      
      .subject-card h3 { 
        margin: 0; 
        font-size: 14px; 
        font-weight: 700; 
        letter-spacing: 0.3px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        line-height: 1.2;
      }

      /* --- MODAL --- */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
      .modal-content { background: white; width: 85%; max-width: 300px; padding: 25px 20px; border-radius: 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .modal-icon { font-size: 45px; color: #ef4444; margin-bottom: 15px; }
    </style>
  </head>
  <body>

    <div id="view-login" class="view-section active-view">
      <div class="auth-container">
        <img src="https://lh3.googleusercontent.com/d/1fcrdmfo3_FNpHt6TOSb3u9Qyu2lBweu9" class="app-logo" alt="Logo" onerror="this.src='https://via.placeholder.com/150?text=Logo'">
        
        <h1 class="app-name">ExamTopper.app</h1>
        <p class="auth-tagline">Learn. Grow. Succeed.</p>

        <div class="input-wrapper"><input type="email" id="login-email" placeholder="Email Address"></div>
        <div class="input-wrapper">
          <input type="password" id="login-pass" placeholder="Password">
          <i class="fas fa-eye toggle-pass" onclick="togglePassword('login-pass', this)"></i>
        </div>
        <button class="primary-btn" id="btn-signin" onclick="handleLogin()">Login</button>
        <div class="link-text" onclick="switchView('view-signup')">Create New Account</div>
        <div class="link-text" onclick="switchView('view-forgot')" style="font-weight:500; font-size:13px; margin-top:10px; color:#64748b;">Forgot Password?</div>
        <div id="login-msg" style="text-align:center; margin-top:20px; color:#ef4444; font-size:14px; font-weight:600;"></div>
      </div>
    </div>

    <div id="view-signup" class="view-section">
      <div class="auth-container">
        <h2 class="auth-title" style="text-align:center; font-size:24px; margin-bottom:25px;">Join Us</h2>
        <div class="input-wrapper"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <div class="input-wrapper"><input type="email" id="reg-email" placeholder="Email Address"></div>
        <div class="input-wrapper"><input type="tel" id="reg-phone" placeholder="Phone Number"></div>
        <div class="input-wrapper">
          <input type="password" id="reg-pass" placeholder="Create Password">
          <i class="fas fa-eye toggle-pass" onclick="togglePassword('reg-pass', this)"></i>
        </div>
        <button class="primary-btn" id="btn-signup" onclick="handleSignup()">Create Account</button>
        <div class="link-text" onclick="switchView('view-login')">Already have an account? Login</div>
        <div id="signup-msg" style="text-align:center; margin-top:15px; font-size:14px;"></div>
      </div>
    </div>

    <div id="view-forgot" class="view-section">
      <div class="auth-container">
        <h2 class="auth-title" style="text-align:center;">Recovery</h2>
        <div class="input-wrapper"><input type="email" id="forgot-email" placeholder="Registered Email"></div>
        <button class="primary-btn" onclick="submitForgot()">Send Reset Link</button>
        <div class="link-text" onclick="switchView('view-login')">Back to Login</div>
        <div id="forgot-msg" style="text-align:center; margin-top:15px;"></div>
      </div>
    </div>

    <div id="view-dashboard" class="view-section">
      <div class="dash-header">
        <div class="welcome-text"><h2 id="user-greeting-name">Hi Student</h2><p>Select your class to begin</p></div>
        <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-power-off"></i></button>
      </div>
      <div id="classes-list" class="classes-container"></div>
    </div>

    <div id="view-subjects" class="view-section">
      <div class="dash-header">
        <div class="back-btn" onclick="goBackToDash()">
           <i class="fas fa-chevron-left"></i> Back
        </div>
        <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-power-off"></i></button>
      </div>
      
      <div style="margin-bottom: 20px; text-align:center;">
        <h2 id="selected-class-title" style="margin:0; font-size:22px; font-weight:800; color:#1e293b;">Class Name</h2>
        <p style="color:#64748b; font-size:13px;">Tap a subject to unlock knowledge</p>
      </div>
      
      <div id="subjects-grid" class="subjects-grid"></div>
    </div>

    <div id="paywall-modal" class="modal-overlay" onclick="closePaywall()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <i class="fas fa-lock modal-icon"></i>
        <h3 style="font-size:20px; margin:0 0 10px 0;">Access Locked</h3>
        <p style="color:#64748b; margin-bottom:20px; font-size:14px;">You do not have a subscription for this class yet.</p>
        <button class="primary-btn" style="background:#ef4444; box-shadow:0 10px 20px -5px rgba(239, 68, 68, 0.4);" onclick="closePaywall()">Okay, Close</button>
      </div>
    </div>

    <script>
      // UPDATE THIS TO YOUR SCRIPT URL
      const API_URL = "https://script.google.com/macros/s/AKfycbyb4kvXBes6OZjc1VQBEFBpWzDUxlyAZ48VUUZTjKv52BIlp36oLTnIiQtMV4Q2I-qokQ/exec";

      // === AUTH & SESSION ===
      function getDeviceId() {
        let id = localStorage.getItem('student_device_id');
        if (!id) {
          id = 'device_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
          localStorage.setItem('student_device_id', id);
        }
        return id;
      }

      window.onload = function() {
          const saved = localStorage.getItem('student_session');
          if (saved) {
              const data = JSON.parse(saved);
              document.getElementById('user-greeting-name').innerText = "Hi " + data.userName;
              renderClasses(data.permissions);
              
              if (window.location.hash !== '#dashboard' && !history.state) {
                  history.replaceState({view: 'view-dashboard'}, null, '');
                  showScreen('view-dashboard');
              } else if (history.state && history.state.view) {
                  handleStateChange(history.state);
              } else {
                  showScreen('view-dashboard');
              }
          } else {
              switchView('view-login');
          }
      };

      // === NAVIGATION GUARD ===
      window.onpopstate = function(e) {
        const session = localStorage.getItem('student_session');
        if (session) {
            if (!e.state || e.state.view === 'view-login' || e.state.view === 'view-signup') {
                history.replaceState({view: 'view-dashboard'}, null, '');
                showScreen('view-dashboard');
                return;
            }
        }

        if (e.state && e.state.view) {
            handleStateChange(e.state);
        } else {
            if (session) showScreen('view-dashboard');
            else showScreen('view-login');
        }
      };

      function handleStateChange(state) {
          if (state.view === 'view-subjects') {
              loadSubjects(state.classKey, state.title, false); 
          } else {
              showScreen(state.view);
          }
      }

      function switchView(viewId, stateData = {}) {
        stateData.view = viewId;
        window.history.pushState(stateData, null, '');
        showScreen(viewId);
      }

      function goBackToDash() {
          switchView('view-dashboard');
      }

      function showScreen(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
      }

      // === DATA ===
      const subjectData = {
        class8: [
          { name: "Mathematics", icon: "fa-calculator", file: "class8math.html", class: "grad-math" },
          { name: "Science", icon: "fa-flask", file: "class8science.html", class: "grad-sci" },
          { name: "Social Science", icon: "fa-globe", file: "class8sst.html", class: "grad-soc" },
          { name: "English", icon: "fa-book-open", file: "class8english.html", class: "grad-eng" },
          { name: "Hindi", icon: "fa-om", file: "class8hindi.html", class: "grad-hin" }
        ],
        class9: [ { name: "Mathematics", icon: "fa-square-root-variable", file: "class9math.html", class: "grad-math" } ],
        class10: [ { name: "Mathematics", icon: "fa-infinity", file: "class10math.html", class: "grad-math" } ],
        class11: [ { name: "Mathematics", icon: "fa-chart-simple", file: "class11math.html", class: "grad-math" } ],
        class12: [ { name: "Mathematics", icon: "fa-superscript", file: "class12math.html", class: "grad-math" } ]
      };

      // === RENDER DASHBOARD ===
      function renderClasses(permissions) {
        const list = document.getElementById('classes-list');
        list.innerHTML = "";
        
        const classes = [
            { key: 'class8', label: 'Class 8', icon: 'fa-cubes', bg: 'bg-c8' },
            { key: 'class9', label: 'Class 9', icon: 'fa-dna', bg: 'bg-c9' },
            { key: 'class10', label: 'Class 10', icon: 'fa-atom', bg: 'bg-c10' },
            { key: 'class11', label: 'Class 11', icon: 'fa-microscope', bg: 'bg-c11' },
            { key: 'class12', label: 'Class 12', icon: 'fa-user-graduate', bg: 'bg-c12' }
        ];

        classes.forEach(c => {
          const hasAccess = permissions[c.key];
          
          const card = document.createElement('div');
          card.className = `class-card ${c.bg} ${hasAccess ? 'unlocked' : 'locked'}`;
          
          card.innerHTML = `
            <div class="class-icon"><i class="fas ${hasAccess ? c.icon : 'fa-lock'}"></i></div>
            <div class="class-info">
                <h3>${c.label}</h3>
                <span>${hasAccess ? 'Tap to Open' : 'Locked'}</span>
            </div>
            ${hasAccess ? '<i class="fas fa-chevron-right arrow-icon"></i>' : ''}
          `;
          
          if (hasAccess) {
              card.onclick = () => loadSubjects(c.key, c.label, true);
          } else {
              card.onclick = () => showPaywall();
          }
          list.appendChild(card);
        });
      }

      // === RENDER SUBJECTS ===
      function loadSubjects(classKey, classTitle, pushHistory) {
        const grid = document.getElementById('subjects-grid');
        const titleEl = document.getElementById('selected-class-title');
        
        grid.innerHTML = ""; 
        titleEl.innerText = classTitle; 
        
        const subjects = subjectData[classKey] || [];

        if(subjects.length > 0) {
          subjects.forEach(sub => {
            const card = document.createElement('a');
            card.className = `subject-card ${sub.class}`;
            card.href = sub.file; 
            card.innerHTML = `
                <i class="fas ${sub.icon}"></i>
                <h3>${sub.name}</h3>
            `;
            grid.appendChild(card);
          });
        } else {
          grid.innerHTML = "<p style='grid-column: span 2; text-align:center; color:#94a3b8;'>No subjects available yet.</p>";
        }

        if (pushHistory) {
            switchView('view-subjects', { classKey: classKey, title: classTitle });
        } else {
            showScreen('view-subjects');
        }
      }

      // === AUTH HANDLERS ===
      function togglePassword(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; icon.classList.replace('fa-eye', 'fa-eye-slash'); } 
        else { input.type = "password"; icon.classList.replace('fa-eye-slash', 'fa-eye'); }
      }

      async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const msg = document.getElementById('login-msg');
        const deviceId = getDeviceId(); 

        if(!email || !pass) return;
        msg.innerText = "Verifying...";
        
        try {
          const res = await fetch(`${API_URL}?action=login&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}&deviceId=${encodeURIComponent(deviceId)}`);
          const data = await res.json();
          if(data.status === 'success') {
            localStorage.setItem('student_session', JSON.stringify(data));
            document.getElementById('user-greeting-name').innerText = "Hi " + data.userName;
            renderClasses(data.permissions);
            history.replaceState({view: 'view-dashboard'}, null, '');
            showScreen('view-dashboard');
          } else { msg.innerText = data.message; }
        } catch(e) { msg.innerText = "Connection Error"; }
      }

      async function handleSignup() {
          const name = document.getElementById('reg-name').value;
          const email = document.getElementById('reg-email').value;
          const phone = document.getElementById('reg-phone').value;
          const pass = document.getElementById('reg-pass').value;
          const msg = document.getElementById('signup-msg');
          try {
            const res = await fetch(`${API_URL}?action=register&name=${name}&email=${email}&pass=${pass}&phone=${phone}`);
            const data = await res.json();
            msg.innerText = data.message;
            if(data.status === 'success') setTimeout(() => switchView('view-login'), 2000);
          } catch(e) { msg.innerText = "Error"; }
      }

      function handleLogout() {
          localStorage.removeItem('student_session');
          history.replaceState({view: 'view-login'}, null, '');
          switchView('view-login');
      }

      async function submitForgot() {
          const email = document.getElementById('forgot-email').value;
          const res = await fetch(`${API_URL}?action=forgot&email=${email}`);
          const data = await res.json();
          document.getElementById('forgot-msg').innerText = data.message;
      }

      function showPaywall() { document.getElementById('paywall-modal').style.display = "flex"; }
      function closePaywall() { document.getElementById('paywall-modal').style.display = "none"; }
    </script>
  </body>
</html>
