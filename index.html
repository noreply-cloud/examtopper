<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>EdTech App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      :root { --primary: #2563eb; --locked: #94a3b8; --bg: #f8fafc; --text: #1e293b; --card-bg: #ffffff; }
      * { box-sizing: border-box; }
      body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }
      
      .view-section { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg); overflow-y: auto; padding: 20px; display: none; padding-bottom: 50px; }
      .active-view { display: block; animation: fadeUp 0.3s ease; }
      @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

      .auth-container { display: flex; flex-direction: column; justify-content: center; min-height: 100%; max-width: 400px; margin: 0 auto; }
      .app-logo { width: 150px; height: auto; display: block; margin: 0 auto 20px auto; border-radius: 12px; object-fit: contain; }
      .auth-title { text-align: center; font-size: 22px; font-weight: 700; margin-bottom: 30px; color: #334155; }
      
      .input-wrapper { position: relative; margin-bottom: 16px; }
      .input-wrapper input { width: 100%; padding: 16px; padding-right: 45px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 16px; outline: none; background: white; }
      .toggle-pass { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: pointer; padding: 5px; font-size: 18px; }
      
      button.primary-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; margin-top: 10px; cursor: pointer; }
      button.primary-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
      .link-text { text-align: center; margin-top: 15px; color: var(--primary); font-size: 14px; font-weight: 600; cursor: pointer; }

      .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-top: 10px; }
      .welcome-text h2 { margin: 0; font-size: 20px; font-weight: 700; }
      .welcome-text p { margin: 4px 0 0; color: #64748b; font-size: 14px; }
      .logout-btn { color: #ef4444; font-size: 18px; padding: 10px; background: #fee2e2; border-radius: 8px; cursor: pointer; }
      
      .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .course-card { background: var(--card-bg); border-radius: 16px; padding: 24px 16px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); cursor: pointer; border: 1px solid #f1f5f9; transition: transform 0.1s; }
      .course-card:active { transform: scale(0.96); }
      .course-card.locked { background: #f8fafc; border: 1px dashed #cbd5e1; }
      .course-card.locked i { color: var(--locked); }
      .course-card.unlocked i { color: var(--primary); }
      .course-card i { font-size: 28px; margin-bottom: 12px; display: block; }
      .course-card h3 { margin: 0; font-size: 15px; font-weight: 600; }

      .content-header { display: flex; align-items: center; margin-bottom: 20px; padding-top: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
      .back-arrow { font-size: 20px; padding: 10px; margin-left: -10px; cursor: pointer; }
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
      .modal-content { background: white; width: 85%; max-width: 320px; padding: 30px 20px; border-radius: 20px; text-align: center; }
      .modal-icon { font-size: 48px; color: #ef4444; margin-bottom: 16px; }
    </style>
  </head>
  <body>
    <div id="view-login" class="view-section active-view">
      <div class="auth-container">
        <img src="https://lh3.googleusercontent.com/d/1fcrdmfo3_FNpHt6TOSb3u9Qyu2lBweu9" class="app-logo" alt="Logo" referrerpolicy="no-referrer">
        <h2 class="auth-title">Learn. Grow. Succeed.</h2>
        <div class="input-wrapper"><input type="email" id="login-email" placeholder="Email Address"></div>
        <div class="input-wrapper"><input type="password" id="login-pass" placeholder="Password"><i class="fas fa-eye toggle-pass" onclick="togglePassword('login-pass', this)"></i></div>
        <button class="primary-btn" id="btn-signin" onclick="handleLogin()">Sign In</button>
        <div class="link-text" onclick="switchView('view-signup')">Create New Account</div>
        <div class="link-text" onclick="switchView('view-forgot')" style="font-weight:400; font-size:13px; margin-top:10px;">Forgot Password?</div>
        <div id="login-msg" style="text-align:center; margin-top:15px; color:#ef4444; font-size:14px;"></div>
      </div>
    </div>

    <div id="view-signup" class="view-section">
      <div class="auth-container">
        <h2 class="auth-title">Create Account</h2>
        <div class="input-wrapper"><input type="text" id="reg-name" placeholder="Full Name"></div>
        <div class="input-wrapper"><input type="email" id="reg-email" placeholder="Email Address"></div>
        <div class="input-wrapper"><input type="tel" id="reg-phone" placeholder="Phone Number"></div>
        <div class="input-wrapper"><input type="password" id="reg-pass" placeholder="Create Password"><i class="fas fa-eye toggle-pass" onclick="togglePassword('reg-pass', this)"></i></div>
        <button class="primary-btn" id="btn-signup" onclick="handleSignup()">Sign Up</button>
        <div class="link-text" onclick="history.back()">Back to Login</div>
        <div id="signup-msg" style="text-align:center; margin-top:15px; font-size:14px;"></div>
      </div>
    </div>

    <div id="view-forgot" class="view-section">
      <div class="auth-container">
        <h2 class="auth-title">Reset Password</h2>
        <div class="input-wrapper"><input type="email" id="forgot-email" placeholder="Your Email"></div>
        <button class="primary-btn" onclick="submitForgot()">Submit Request</button>
        <div class="link-text" onclick="history.back()">Back to Login</div>
        <div id="forgot-msg" style="text-align:center; margin-top:15px;"></div>
      </div>
    </div>

    <div id="view-dashboard" class="view-section">
      <div class="dash-header">
        <div class="welcome-text"><h2 id="user-greeting-name">Hi Student</h2><p>Let's start learning</p></div>
        <div class="logout-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></div>
      </div>
      <div id="courses-grid" class="grid-container"></div>
    </div>

    <div id="view-content" class="view-section">
      <div class="content-header">
        <i class="fas fa-arrow-left back-arrow" onclick="history.back()"></i>
        <h3 id="current-course-title" style="margin:0;">Class</h3>
      </div>
      <div id="content-body"></div>
    </div>

    <div id="paywall-modal" class="modal-overlay" onclick="closePaywall()">
      <div class="modal-content" onclick="event.stopPropagation()">
        <i class="fas fa-lock modal-icon"></i><h3>Access Locked</h3>
        <p>You do not have a subscription for this class.</p>
        <button class="primary-btn" style="background:#ef4444;" onclick="closePaywall()">Close</button>
      </div>
    </div>

    <script>
      // ===========================================
      // CONFIGURATION
      // ===========================================
      const API_URL = "https://script.google.com/macros/s/AKfycbwjrkfBUk-h4KBw5N0DhLadvsw8wSddiUltj1sZ5xQGG52U4AssWl1En0d-s9nv606q/exec";

      let userPermissions = {};
      let currentUserEmail = "";

      // NAVIGATION
      window.history.replaceState({view: 'view-login', subState: null}, null, '');
      window.onpopstate = function(e) {
        if (e.state && e.state.view) {
          if (e.state.view === 'view-content' && window.handleCourseNav) {
             window.handleCourseNav(e.state.subState);
             showScreen('view-content'); 
          } else {
             showScreen(e.state.view);
          }
        } else { showScreen('view-login'); }
      };

      function switchView(viewId, subState = null) {
        window.history.pushState({view: viewId, subState: subState}, null, '');
        showScreen(viewId);
      }

      function showScreen(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
      }

      function togglePassword(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } 
        else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
      }

      // SCRIPT RUNNER
      function setInnerHtmlAndRunScripts(containerId, htmlContent) {
        const container = document.getElementById(containerId);
        container.innerHTML = htmlContent;
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          if (oldScript.src) { newScript.src = oldScript.src; newScript.async = false; } 
          else { newScript.textContent = oldScript.textContent; }
          document.body.appendChild(newScript);
        });
      }

      // API FUNCTIONS
      async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const btn = document.getElementById('btn-signin');
        const msg = document.getElementById('login-msg');

        if(!email || !pass) { msg.innerText = "Fill all fields"; return; }
        btn.disabled = true; btn.innerText = "Verifying..."; msg.innerText = "";

        try {
          const res = await fetch(`${API_URL}?action=login&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}`);
          const data = await res.json();
          btn.disabled = false; btn.innerText = "Sign In";

          if(data.status === 'success') {
            currentUserEmail = email;
            userPermissions = data.permissions;
            document.getElementById('user-greeting-name').innerText = "Hi " + data.userName;
            renderDashboard();
            switchView('view-dashboard');
          } else { msg.innerText = data.message; }
        } catch(e) { btn.disabled = false; msg.innerText = "Connection Error"; }
      }

      async function handleSignup() {
        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const phone = document.getElementById('reg-phone').value;
        const pass = document.getElementById('reg-pass').value;
        const btn = document.getElementById('btn-signup');
        const msg = document.getElementById('signup-msg');
        if(!name || !email || !pass) { msg.style.color='red'; msg.innerText = "Fill required"; return; }
        btn.disabled = true; btn.innerText = "Creating..."; msg.innerText = "";
        try {
          const res = await fetch(`${API_URL}?action=register&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}&phone=${encodeURIComponent(phone)}`);
          const data = await res.json();
          btn.disabled = false; btn.innerText = "Sign Up";
          if(data.status === 'success') { msg.style.color = 'green'; msg.innerText = data.message; setTimeout(() => history.back(), 2000); }
          else { msg.style.color = 'red'; msg.innerText = data.message; }
        } catch(e) { btn.disabled = false; msg.innerText = "Connection Error"; }
      }

      async function handleLogout() {
        if(confirm("Logout?")) {
          fetch(`${API_URL}?action=logout&email=${encodeURIComponent(currentUserEmail)}`);
          currentUserEmail = ""; userPermissions = {}; 
          document.getElementById('login-pass').value = "";
          window.history.replaceState({view: 'view-login'}, null, '');
          showScreen('view-login');
        }
      }

      async function submitForgot() {
        const email = document.getElementById('forgot-email').value;
        if(email) fetch(`${API_URL}?action=forgot&email=${encodeURIComponent(email)}`);
        document.getElementById('forgot-msg').innerText = "Request Sent";
      }

      function renderDashboard() {
        const grid = document.getElementById('courses-grid');
        grid.innerHTML = "";
        const classes = [{ key: 'class8', label: 'Class 8' }, { key: 'class9', label: 'Class 9' }, { key: 'class10', label: 'Class 10' }, { key: 'class11', label: 'Class 11' }, { key: 'class12', label: 'Class 12' }];
        classes.forEach(c => {
          const hasAccess = userPermissions[c.key];
          const card = document.createElement('div');
          card.className = `course-card ${hasAccess ? 'unlocked' : 'locked'}`;
          card.innerHTML = `<i class="fas ${hasAccess ? 'fa-book-open' : 'fa-lock'}"></i><h3>${c.label}</h3>`;
          card.onclick = () => hasAccess ? openCourse(c.key, c.label) : showPaywall();
          grid.appendChild(card);
        });
      }

      async function openCourse(classKey, label) {
        document.getElementById('current-course-title').innerText = label;
        document.getElementById('content-body').innerHTML = `<div style="text-align:center; margin-top:50px;"><i class="fas fa-spinner fa-spin"></i> Loading AI...</div>`;
        window.handleCourseNav = null;
        switchView('view-content', { section: 'home' });

        try {
          const res = await fetch(`${API_URL}?action=getContent&pageName=${classKey}`);
          const data = await res.json();
          if(data.status === 'success') {
            setInnerHtmlAndRunScripts('content-body', data.html);
          } else { document.getElementById('content-body').innerHTML = "<p>Content Unavailable.</p>"; }
        } catch(e) { document.getElementById('content-body').innerHTML = "<p>Connection error.</p>"; }
      }

      function showPaywall() { document.getElementById('paywall-modal').style.display = "flex"; }
      function closePaywall() { document.getElementById('paywall-modal').style.display = "none"; }
    </script>
  </body>
</html>
